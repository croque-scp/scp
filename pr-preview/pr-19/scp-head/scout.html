<!DOCTYPE html>
<html>
  <head>
    <style>
      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
      }
      body {
        height: 100vh !important;
      }
    </style>

    <script>
      "use strict";
      window.isScout = true;

      function getController() {
        for (const frame of Array.prototype.slice.call(parent)) {
          try {
            if (frame.isController) return frame;
          } catch (error) {
            if (!(error instanceof DOMException)) throw error;
          }
        }
      }

      (async () => {
        const params = new URLSearchParams(location.search);

        // Assertion syntax: comma-separated list of assertion IDs that this scout records visibility for
        const assertions = (params.get("assertion") || "0").split(",");
        if (assertions.some((id) => !/^[0-9]+$/.test(id)))
          throw new Error(`Invalid assertion ID ${id}`);

        // Contradiction sytax: comma-separated list of contradiction IDs and/or conditions that this scout uses to invalidate assertions
        // A contradiction condition is e.g. "24?31" which means "trigger contradiction 31 if assertion 24 is active"
        const contradictions = (params.get("contradiction") || "0")
          .split(",")
          .map((contradiction) => {
            if (contradiction.includes("?")) {
              const [conditionId, contradictionId] = contradiction.split("?");
              return { conditionId, contradictionId };
            }
            return { contradictionId: contradiction, conditionId: null };
          });
        if (contradictions.some((id) => !/^[0-9]+$/.test(id)))
          throw new Error(`Invalid assertion ID ${id}`);

        if (!assertions.length && !contradictions.length) {
          throw new Error("Unconfigured scout :(");
        }

        const scoutName = location.search;

        // Attempt to get the controller
        let controller = getController();
        for (let attempts = 0; attempts < 3; attempts += 1) {
          if (controller) break;
          await new Promise((resolve) => setTimeout(resolve, 500));
          controller = getController();
        }
        if (!controller)
          throw new Error(`Scout ${scoutName} failed to get controller`);

        // Assume that as soon as this scout is asked to load, it's ready to work
        const observer = new IntersectionObserver(
          (entries) => {
            controller.postMessage({
              scoutName,
              isIntersecting: entries[0].isIntersecting,
              assertions,
              contradictions,
            });
          },
          { threshold: 0 }
        );
        observer.observe(document.body);

        // Listen to instructions coming from controller
        addEventListener("message", (message) => {
          if (message.origin !== location.origin) return;
          if (message.data.scoutName !== scoutName) return;

          if (message.data.instruction === "destroy") {
            observer.disconnect();
            location.replace("about:blank");
          }
        });
      })();
    </script>
  </head>

  <body></body>
</html>
